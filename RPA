import pandas as pd
import pywhatkit as kit
import threading
from concurrent.futures import ThreadPoolExecutor

# Caminho do arquivo da planilha
file_path = r"C:\Users\Beep Saude.BEEP1441\OneDrive\Documentos\Sales\RPA\Campanhas.xlsx"
sheet_name = 'Campanhas'  # Nome da aba da planilha correta

# Caminho da imagem da campanha
image_path = r"C:\Users\Beep Saude.BEEP1441\OneDrive\Documentos\Sales\RPA\MENINGO70 - DF e CMP.png"

# C√≥digo do pa√≠s
codigo_pais = '+55'  # Altere conforme o c√≥digo do pa√≠s necess√°rio

# Verificar se a planilha existe no arquivo
xls = pd.ExcelFile(file_path)
if sheet_name in xls.sheet_names:
    df = pd.read_excel(file_path, sheet_name=sheet_name)
else:
    raise ValueError(f"A planilha '{sheet_name}' n√£o foi encontrada no arquivo.")

# Criar um bloqueio para sincronizar o acesso √† √°rea de transfer√™ncia
clipboard_lock = threading.Lock()

def send_message(row):
    nome = row['Nome']  # Ajustar o nome da coluna conforme necess√°rio
    cupom = row['c√≥digo original']  # Ajustar o nome da coluna conforme necess√°rio
    telefone = str(row['Fone 1'])  # Ajustar o nome da coluna conforme necess√°rio

    if not telefone.startswith('+'):
        telefone = codigo_pais + telefone

    # Construir a mensagem personalizada com o novo texto
    mensagem = (f"Ol√°, Dr(a). *{nome}*!\n\n"
                "Estendemos a dura√ß√£o do desconto no *Pacote Meningites* em Bras√≠lia e Campinas.\n\n"
                "Basta usar o c√≥digo *MENINGO70* e garantir a condi√ß√£o especial! üòâ\n\n"
                "üìä A meningite bacteriana √© fatal em 10% dos casos no Brasil e pode ser prevenida com as vacinas meningoc√≥cicas ACWY e B, "
                "que fazem parte do Pacote Meningites.\n\n"
                "Compartilhe com os seus pacientes e espalhe sa√∫de!\n\n"
                "*V√°lido para Bras√≠lia e Campinas. Valor promocional referente a uma dose de cada vacina Pfizer. "
                "Os pre√ßos podem variar conforme a regi√£o. Veja condi√ß√µes no site.*")

    try:
        with clipboard_lock:
            print(f"Enviando mensagem para {nome} no n√∫mero {telefone}")
            kit.sendwhats_image(receiver=telefone, img_path=image_path, caption=mensagem, wait_time=20, tab_close=True)
            print(f"Mensagem enviada para {nome} com sucesso!")
    except Exception as e:
        print(f"Erro ao enviar mensagem para {nome}: {e}")

try:
    # N√∫mero de threads
    num_threads = 5  # Ajuste o n√∫mero de threads conforme necess√°rio
    with ThreadPoolExecutor(max_workers=num_threads) as executor:
        executor.map(send_message, [row for index, row in df.iterrows()])

    print("Envio de mensagens conclu√≠do!")

except KeyboardInterrupt:
    print("Envio de mensagens interrompido pelo usu√°rio.")
    
